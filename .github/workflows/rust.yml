name: Rust

on:
  push:
    branches: [ "main" ]
    paths:
      - 'rust/**'
      - 'build/rust_ci.py'
      - 'build/rust_command.py'
      - '.github/workflows/rust.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'rust/**'
      - 'build/rust_ci.py'
      - 'build/rust_command.py'
      - '.github/workflows/rust.yml'

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: 2  # Reduce parallel jobs to avoid OOM during linking

jobs:
  native:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Show initial disk space
      run: |
        echo "Initial disk space:"
        df -h / | awk 'NR==1 || /\/$/'

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android /usr/local/.ghcup /usr/share/swift /opt/hostedtoolcache /usr/share/az_* /opt/az /usr/local/share/powershell /usr/share/kotlinc
        sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^mongodb-.*' '^mysql-.*' '^php.*' azure-cli google-chrome-stable powershell mono-devel 2>/dev/null || true
        sudo apt-get autoremove -y
        sudo apt-get clean
        docker rmi $(docker images -q) 2>/dev/null || true

    - name: Install mold linker
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y mold

    - name: Install cargo-machete
      run: cargo install cargo-machete

    - name: Run native CI
      run: ./build/rust_ci.py native

    - name: Cleanup build artifacts
      if: always()
      run: |
        rm -rf rust/target/debug/deps/*
        rm -rf rust/target/debug/incremental/*

  wasm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Show initial disk space
      run: |
        echo "Initial disk space:"
        df -h / | awk 'NR==1 || /\/$/'

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android /usr/local/.ghcup /usr/share/swift /opt/hostedtoolcache /usr/share/az_* /opt/az /usr/local/share/powershell /usr/share/kotlinc
        sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^mongodb-.*' '^mysql-.*' '^php.*' azure-cli google-chrome-stable powershell mono-devel 2>/dev/null || true
        sudo apt-get autoremove -y
        sudo apt-get clean
        docker rmi $(docker images -q) 2>/dev/null || true

    - name: Install wasm tooling
      run: |
        rustup target add wasm32-unknown-unknown
        cargo install wasm-pack

    - name: Run WASM CI
      run: ./build/rust_ci.py wasm

    - name: Cleanup build artifacts
      if: always()
      run: |
        rm -rf rust/datafusion-wasm/target/*
