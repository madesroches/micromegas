# Plan: Admin Feature to Retire Partitions with Outdated Schemas

## Overview

Add admin DataFusion User-Defined Table Functions (UDTFs) that allow easy identification and retirement of partitions with outdated schemas. These functions will be callable from the Python API and allow for schema evolution by cleaning up partitions that were created with older schema versions.

## Current State Analysis

### Existing Infrastructure

1. **Schema Hash System**: Each view has a `file_schema_hash` that identifies the schema version
   - Stored in `lakehouse_partitions.file_schema_hash` column
   - Generated by each view's `get_file_schema_hash()` method
   - Used to detect when partitions are out of date

2. **Existing Retire Functionality**: 
   - `retire_partitions()` function in `rust/analytics/src/lakehouse/write_partition.rs`
   - Admin CLI command `retire-partitions` in `rust/telemetry-admin-cli/src/telemetry_admin.rs`
   - Table function for SQL-based retirement in `rust/analytics/src/lakehouse/retire_partitions_table_function.rs`

3. **DataFusion Table Function Registration**:
   - UDTFs registered in `rust/analytics/src/lakehouse/query.rs:register_lakehouse_functions()`
   - Existing functions: `list_partitions`, `retire_partitions`, `materialize_partitions`, etc.
   - Called via `ctx.register_udtf()` method

4. **Database Schema**: 
   - `lakehouse_partitions` table tracks all partitions with their schema hashes
   - Indexed by view names and time ranges

## Implementation Plan

### Phase 1: Schema Discovery (‚úÖ COMPLETED)

**`list_view_sets()`** - Show available view sets with their current schema information
```sql
SELECT * FROM list_view_sets();
```
Output columns:
- `view_set_name`: Name of the view set (e.g., "log_entries", "measures")
- `current_schema_hash`: Binary hash identifying current schema version  
- `schema`: Full schema as a formatted string
- `has_view_maker`: Boolean indicating if view set supports non-global instances
- `global_instance_available`: Boolean indicating if a global instance exists

**Implementation details:**
- Created `catalog.rs` with `list_view_sets()` function and `ViewSetInfo` struct
- Created `list_view_sets_table_function.rs` UDTF implementation
- Enhanced `ViewMaker` trait with `get_schema_hash()` and `get_schema()` methods
- Updated all ViewMaker implementations with SCHEMA_VERSION constants
- Added `get_view_sets()` to ViewFactory for catalog access
- Registered in DataFusion query context

### Phase 2: Partition Analysis (‚úÖ COMPLETED)

**Unit Tests Added** - `/home/mad/micromegas/rust/analytics/tests/catalog_tests.rs`
- ‚úÖ `test_list_view_sets_catalog()` - Tests basic functionality and column structure
- ‚úÖ `test_view_sets_schema_hash_consistency()` - Validates schema versions (version numbers like `[4]`, not SHA-256 hashes)
- ‚úÖ `test_view_sets_properties()` - Tests view set properties (global_instance_available, has_view_maker)
- ‚úÖ Tests work without database connection using minimal ViewFactory setup
- ‚úÖ Verified log_entries and measures view sets both have schema version `[4]` and are view-maker-only

**Key Discovery**: Schema "hashes" are actually version numbers (e.g., `[4]`) not cryptographic hashes

### Phase 2.5: Outdated Partition Discovery (üìù PLANNED)

**`list_outdated_partitions([view_set_name])`** - Identify partitions with outdated schemas
```sql
SELECT * FROM list_outdated_partitions();
SELECT * FROM list_outdated_partitions('log_entries');
```
Output columns:
- `view_set_name`: View set name
- `view_instance_id`: Instance ID (e.g., process_id or 'global')
- `outdated_schema_hash`: The old schema hash in the partition
- `current_schema_hash`: The current schema hash from ViewFactory
- `partition_count`: Number of outdated partitions

**Implementation tasks:**
- Create `list_outdated_partitions_table_function.rs`
- Add method to catalog.rs to query lakehouse_partitions table
- Compare stored schema versions with current ViewFactory versions
- Register function in DataFusion

### Phase 3: Automated Retirement (üìù PLANNED)

**`retire_incompatible_partitions(view_set_name)`** - Retire partitions with incompatible schemas
```sql
SELECT * FROM retire_incompatible_partitions('log_entries');
SELECT * FROM retire_incompatible_partitions('measures');
```
Output columns:
- `view_set_name`: View set that was processed
- `view_instance_id`: Instance ID of partitions retired
- `partitions_retired`: Count of partitions retired
- `storage_freed_bytes`: Total bytes freed

**Implementation tasks:**
- Create `retire_incompatible_partitions_table_function.rs`
- Implement bulk retirement logic with transactions
- Add comprehensive logging for audit trail
- Integrate with existing `retire_partitions()` function
- Add safety checks and validation
- Register function in DataFusion

## Technical Details

### Database Query for Outdated Partitions
```sql
SELECT p.view_set_name, p.view_instance_id, p.file_schema_hash, COUNT(*) as partition_count
FROM lakehouse_partitions p
WHERE p.file_schema_hash != $1 -- current_schema_hash parameter
GROUP BY p.view_set_name, p.view_instance_id, p.file_schema_hash
ORDER BY p.view_set_name, p.view_instance_id;
```

### Safety Features

1. **Transactional Operations**: All retirement operations use database transactions
2. **Detailed Logging**: Log all retirement operations for audit trail
3. **Parameter Validation**: Validate schema hashes and view names
4. **Concurrent Safety**: Handle concurrent partition updates during retirement

## Usage Examples

### From Python API
```python
import micromegas

# Connect to analytics service
client = micromegas.AnalyticsClient('localhost:32010')

# See current schema versions across all views
schema_versions = client.sql("SELECT * FROM list_view_sets()")

# Find outdated partitions for log_entries view
outdated = client.sql("SELECT * FROM list_outdated_partitions('log_entries')")

# Retire incompatible partitions for measures view
result = client.sql("SELECT * FROM retire_incompatible_partitions('measures')")
```

### Direct SQL Usage
```sql
-- See current schema versions across all views
SELECT * FROM list_view_sets();

-- Find outdated partitions for log_entries view
SELECT * FROM list_outdated_partitions('log_entries');

-- Retire incompatible partitions for measures view
SELECT * FROM retire_incompatible_partitions('measures');
```

## Benefits

1. **API Integration**: Direct access from Python API for automation
2. **SQL Flexibility**: Use standard SQL queries for complex analysis
3. **Operational Efficiency**: Automate identification and cleanup of outdated partitions
4. **Schema Evolution**: Enable safe schema changes by cleaning up old versions
5. **Storage Optimization**: Remove partitions that can't be queried due to schema mismatches
6. **Data Consistency**: Ensure all partitions use current schema versions
7. **Observability**: Provide visibility into schema version distribution via SQL

## Risks & Mitigations

1. **Data Loss Risk**: Mitigated by transactional operations and comprehensive logging
2. **Performance Impact**: Mitigated by efficient database queries and batched operations
3. **Schema Detection Issues**: Mitigated by robust error handling and logging
4. **Concurrent Operations**: Mitigated by proper transaction handling
5. **Parameter Validation**: Mitigated by thorough input validation